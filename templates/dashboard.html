{% extends "base.html" %}

{% block content %}
<!-- Weigh-in Reminder -->
{% if show_weigh_reminder %}
<div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
    <i class="fas fa-weight me-2"></i>{{ t('dash.weigh_reminder') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card" style="background: var(--gradient-primary);">
            <div class="stat-icon"><i class="fas fa-star"></i></div>
            <div class="stat-value">{{ user.level }}</div>
            <div class="stat-label">{{ t('dash.level') }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card" style="background: var(--gradient-warning);">
            <div class="stat-icon"><i class="fas fa-fire"></i></div>
            <div class="stat-value">{{ streak }}</div>
            <div class="stat-label">{{ t('dash.streak') }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card" style="background: var(--gradient-success);">
            <div class="stat-icon"><i class="fas fa-dumbbell"></i></div>
            <div class="stat-value">{{ total_activities }}</div>
            <div class="stat-label">{{ t('dash.activities') }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card" style="background: var(--gradient-info);">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-value">{{ total_minutes }}</div>
            <div class="stat-label">{{ t('dash.minutes') }}</div>
        </div>
    </div>
</div>

<!-- Player Class Badge -->
{% if user_class %}
<div class="card mb-4">
    <div class="card-body d-flex align-items-center">
        <div class="me-3" style="width: 50px; height: 50px; border-radius: 50%; background: {{ user_class.gradient }}; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: white;">
            <i class="fas {{ user_class.icon }}"></i>
        </div>
        <div>
            <div class="fw-bold fs-5" style="color: {{ user_class.color }};">
                {{ t('dash.class_info') }}: {{ user_class['name_' ~ current_lang] if user_class['name_' ~ current_lang] is defined else user_class.name_es }}
            </div>
            <div class="text-muted" style="font-size: 0.85rem;">
                {{ t('class.specialty') }}: {{ user_class.specialty | join(', ') }} &middot; +{{ (user_class.bonus * 100) | int }}% {{ t('class.bonus') }}
            </div>
        </div>
    </div>
</div>
{% elif user.level >= 5 %}
<div class="card mb-4">
    <div class="card-body text-center py-3">
        <p class="mb-2 text-muted">{{ t('dash.no_class') }}</p>
        <a href="{{ url_for('select_class') }}" class="btn btn-primary">
            <i class="fas fa-shield-alt me-1"></i>{{ t('dash.select_class_btn') }}
        </a>
    </div>
</div>
{% endif %}

<!-- EXP Progress -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="level-badge"><i class="fas fa-star"></i> {{ t('dash.level') }} {{ user.level }}</span>
            <span class="text-muted">{{ "%.1f"|format(user.exp) }} / {{ exp_for_next }} EXP</span>
        </div>
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: 0; background: var(--gradient-primary);"
                 data-progress="{{ progress }}"
                 aria-valuenow="{{ progress }}"
                 aria-valuemin="0"
                 aria-valuemax="100">
                {{ "%.1f"|format(progress) }}%
            </div>
        </div>
    </div>
</div>

<!-- Challenges Preview -->
{% if weekly_challenges %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-flag me-2"></i>{{ t('dash.weekly_challenges') }}</h5>
        <a href="{{ url_for('challenges') }}" class="btn btn-sm btn-outline-light">{{ t('dash.view_all') }}</a>
    </div>
    <div class="card-body">
        {% for ch in weekly_challenges[:2] %}
        <div class="challenge-card {{ 'completed' if ch.completed }}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <i class="fas {{ ch.icon }} me-2" style="color: {{ '#10b981' if ch.completed else '#8b5cf6' }};"></i>
                    <span class="fw-bold">{{ ch.name }}</span>
                </div>
                <span class="badge {{ 'bg-success' if ch.completed else 'bg-info' }}">
                    {% if ch.completed %}
                    <i class="fas fa-check me-1"></i>{{ t('chal.completed') }}
                    {% else %}
                    {{ ch.progress }}/{{ ch.target }}
                    {% endif %}
                </span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar"
                     style="width: {{ (ch.progress / ch.target * 100) | int }}%; background: {{ 'var(--gradient-success)' if ch.completed else 'var(--gradient-primary)' }};"
                     aria-valuenow="{{ ch.progress }}" aria-valuemin="0" aria-valuemax="{{ ch.target }}">
                </div>
            </div>
            <div class="text-muted mt-1" style="font-size: 0.8rem;">
                {{ ch.desc }} &middot; {{ t('chal.reward') }}: +{{ ch.reward_exp }} EXP
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-weight"></i> {{ t('dash.weight_history') }}</h5>
            </div>
            <div class="card-body">
                <canvas id="weightChart"></canvas>
                {% if not weight_dates %}
                <p class="text-center text-muted mt-3">{{ t('dash.no_weight_data') }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> {{ t('dash.exercise_types') }}</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="typeChart"></canvas>
                {% if not type_labels %}
                <p class="text-center text-muted">{{ t('dash.no_type_data') }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activity Heatmap -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>{{ t('dash.heatmap') }}</h5>
    </div>
    <div class="card-body">
        <div id="heatmap-container" style="overflow-x: auto;">
            <div id="heatmap-grid" style="display: inline-grid; gap: 2px;"></div>
        </div>
        <div class="d-flex align-items-center justify-content-end mt-2" style="font-size: 0.75rem; color: var(--text-muted);">
            <span class="me-1">{{ t('general.low') if current_lang == 'en' else 'Menos' }}</span>
            <span class="heatmap-cell" style="background: {{ '#161b22' if current_theme == 'dark' else '#ebedf0' }};"></span>
            <span class="heatmap-cell" style="background: #7c3aed33;"></span>
            <span class="heatmap-cell" style="background: #7c3aed80;"></span>
            <span class="heatmap-cell" style="background: #7c3aedcc;"></span>
            <span class="heatmap-cell" style="background: #7c3aed;"></span>
            <span class="ms-1">{{ t('general.high') if current_lang == 'en' else 'Mas' }}</span>
        </div>
    </div>
</div>

<!-- Achievements -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-trophy"></i> {{ t('dash.achievements') }}</h5>
        <span class="badge bg-info">{{ unlocked_count }}/{{ achievements|length }}</span>
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for a in achievements %}
            <div class="col-6 col-md-4 col-lg-3">
                <div class="achievement-card {{ 'unlocked' if a.unlocked else 'locked' }}">
                    <div class="achievement-icon"><i class="fas {{ a.icon }}"></i></div>
                    <div class="fw-bold" style="font-size: 0.85rem;">{{ a.name_en if current_lang == 'en' and a.name_en else a.name }}</div>
                    <div class="text-muted" style="font-size: 0.75rem;">{{ a.desc_en if current_lang == 'en' and a.desc_en else a.desc }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> {{ t('dash.recent_activities') }}</h5>
        <a href="{{ url_for('history') }}" class="btn btn-sm btn-outline-light">{{ t('dash.view_all') }}</a>
    </div>
    <div class="card-body">
        {% if activities %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>{{ t('hist.date') }}</th>
                        <th>{{ t('hist.exercise') }}</th>
                        <th>{{ t('hist.duration') }}</th>
                        <th>{{ t('hist.intensity') }}</th>
                        <th>{{ t('hist.exp') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in activities %}
                    <tr>
                        <td>
                            {% if activity.date and activity.date.strftime is defined %}
                                {{ activity.date.strftime('%d/%m/%Y %H:%M') }}
                            {% elif activity.date %}
                                {{ activity.date }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ activity.exercise_type }}</td>
                        <td>{{ activity.duration }} min</td>
                        <td>
                            {% if activity.intensity == 'low' %}
                            <span class="badge bg-success">{{ t('general.low') }}</span>
                            {% elif activity.intensity == 'medium' %}
                            <span class="badge bg-warning">{{ t('general.medium') }}</span>
                            {% else %}
                            <span class="badge bg-danger">{{ t('general.high') }}</span>
                            {% endif %}
                        </td>
                        <td><span class="text-success">+{{ "%.1f"|format(activity.exp_gained) }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-running fa-3x text-muted mb-3"></i>
            <p class="text-muted">{{ t('dash.no_activities') }}</p>
            <a href="{{ url_for('add_activity') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> {{ t('dash.first_activity') }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Floating Action Button -->
<div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1000;">
    <a href="{{ url_for('add_activity') }}" class="btn btn-primary btn-lg rounded-circle shadow-lg" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-plus fa-lg"></i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    var gridColor = isDark ? '#21262d' : '#dee2e6';
    var textColor = isDark ? '#8b949e' : '#6c757d';

    // Animate progress bar
    const progressBar = document.querySelector('.progress-bar[data-progress]');
    if (progressBar) {
        const progress = progressBar.dataset.progress;
        setTimeout(function() { progressBar.style.width = progress + '%'; }, 100);
    }

    // Weight Chart
    var weightDates = {{ weight_dates|tojson }};
    var weightValues = {{ weight_values|tojson }};
    if (weightDates.length > 0) {
        new Chart(document.getElementById('weightChart'), {
            type: 'line',
            data: {
                labels: weightDates,
                datasets: [{
                    label: '{{ t("hist.weight") }} (kg)',
                    data: weightValues,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: '#8b5cf6',
                    pointRadius: 4,
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { grid: { color: gridColor }, ticks: { color: textColor } }
                }
            }
        });
    }

    // Activity Type Chart
    var typeLabels = {{ type_labels|tojson }};
    var typeData = {{ type_data|tojson }};
    if (typeLabels.length > 0) {
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeData,
                    backgroundColor: [
                        '#6366f1', '#10b981', '#f59e0b', '#ef4444',
                        '#06b6d4', '#8b5cf6', '#ec4899', '#14b8a6'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: textColor, padding: 12 }
                    }
                }
            }
        });
    }

    // Activity Heatmap
    var heatmapData = {{ heatmap|tojson }};
    var grid = document.getElementById('heatmap-grid');
    if (grid) {
        var today = new Date();
        var isDark = '{{ current_theme }}' === 'dark';
        var emptyColor = isDark ? '#161b22' : '#ebedf0';
        var colors = [
            emptyColor,
            'rgba(124, 58, 237, 0.2)',
            'rgba(124, 58, 237, 0.5)',
            'rgba(124, 58, 237, 0.8)',
            'rgba(124, 58, 237, 1.0)'
        ];

        // Calculate ~26 weeks (approx 6 months) back
        var numWeeks = 26;
        var totalDays = numWeeks * 7;

        // Find the start date: go back totalDays from today and align to the previous Sunday
        var startDate = new Date(today);
        startDate.setDate(startDate.getDate() - totalDays);
        // Align to Sunday (day 0)
        var startDay = startDate.getDay();
        if (startDay !== 0) {
            startDate.setDate(startDate.getDate() - startDay);
        }

        // Recalculate the actual number of weeks from startDate to today
        var diffMs = today.getTime() - startDate.getTime();
        var actualDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24)) + 1;
        var actualWeeks = Math.ceil(actualDays / 7);

        grid.style.gridTemplateRows = 'repeat(7, 12px)';
        grid.style.gridTemplateColumns = 'repeat(' + actualWeeks + ', 12px)';

        for (var week = 0; week < actualWeeks; week++) {
            for (var day = 0; day < 7; day++) {
                var cellDate = new Date(startDate);
                cellDate.setDate(cellDate.getDate() + (week * 7) + day);

                // Skip future dates
                if (cellDate > today) {
                    var emptyCell = document.createElement('div');
                    emptyCell.className = 'heatmap-cell';
                    emptyCell.style.background = 'transparent';
                    grid.appendChild(emptyCell);
                    continue;
                }

                var dateStr = cellDate.getFullYear() + '-' +
                    String(cellDate.getMonth() + 1).padStart(2, '0') + '-' +
                    String(cellDate.getDate()).padStart(2, '0');
                var count = heatmapData[dateStr] || 0;
                var colorIndex = 0;
                if (count === 1) colorIndex = 1;
                else if (count === 2) colorIndex = 2;
                else if (count >= 3 && count <= 4) colorIndex = 3;
                else if (count >= 5) colorIndex = 4;

                var cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.style.background = colors[colorIndex];
                cell.style.gridRow = (day + 1).toString();
                cell.style.gridColumn = (week + 1).toString();
                cell.title = dateStr + ': ' + count + ' actividad(es)';
                grid.appendChild(cell);
            }
        }
    }
});
</script>
{% endblock %}
